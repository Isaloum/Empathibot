<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MindCare</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="flex items-center">
                        <i class="fas fa-heart text-2xl mr-3"></i>
                        <span class="text-xl font-bold">MindCare</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="hover:text-blue-200">Home</a>
                    <a href="/assessment" class="hover:text-blue-200">New Assessment</a>
                    <button id="crisis-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold">
                        Crisis Help
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="gradient-bg text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-bold mb-2">Mental Health Dashboard</h1>
            <p class="text-blue-100">Track your mental wellness journey and insights</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Assessments</p>
                        <p id="total-assessments" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-calendar-check text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Last Assessment</p>
                        <p id="last-assessment" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                        <i class="fas fa-brain text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Current Risk Level</p>
                        <p id="current-risk" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-trending-up text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Trend</p>
                        <p id="trend" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Depression Trend Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Depression Scores Over Time (PHQ-9)</h2>
                <canvas id="depressionChart" width="400" height="200"></canvas>
            </div>

            <!-- Anxiety Trend Chart -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Anxiety Scores Over Time (GAD-7)</h2>
                <canvas id="anxietyChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Assessments -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Recent Assessments</h2>
                <a href="/assessment" class="gradient-bg text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                    Take New Assessment
                </a>
            </div>
            <div id="recent-assessments" class="space-y-4">
                <!-- Loading indicator -->
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                </div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Current Recommendations</h2>
            <div id="current-recommendations" class="space-y-3">
                <!-- Recommendations will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Crisis Resources Modal -->
    <div id="crisis-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-2xl w-full p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-red-600">Crisis Resources</h2>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4 text-red-600">Immediate Help</h3>
                        <div id="immediate-help" class="space-y-3">
                            <!-- Crisis resources will be loaded here -->
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Mental Health Resources</h3>
                        <div id="mental-health-resources" class="space-y-3">
                            <!-- Resources will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                    <p class="text-sm text-yellow-800">
                        <strong>Important:</strong> If you're experiencing a mental health emergency, 
                        please call 911 or go to your nearest emergency room immediately.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.userId = sessionStorage.getItem('user_id');
                this.assessmentHistory = [];
                this.depressionChart = null;
                this.anxietyChart = null;
                
                this.initializeEventListeners();
                this.loadDashboardData();
            }
            
            initializeEventListeners() {
                document.getElementById('crisis-btn').addEventListener('click', () => this.showCrisisModal());
                document.getElementById('close-modal').addEventListener('click', () => this.hideCrisisModal());
            }
            
            async loadDashboardData() {
                try {
                    // For demo purposes, we'll generate some sample data
                    // In a real app, this would fetch from the API
                    this.generateSampleData();
                    this.updateQuickStats();
                    this.renderCharts();
                    this.renderRecentAssessments();
                    this.renderCurrentRecommendations();
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                    this.showError('Failed to load dashboard data');
                }
            }
            
            generateSampleData() {
                // Generate sample assessment history for demonstration
                const now = new Date();
                this.assessmentHistory = [];
                
                for (let i = 0; i < 10; i++) {
                    const date = new Date(now - (i * 7 * 24 * 60 * 60 * 1000)); // Weekly intervals
                    const phq9Score = Math.floor(Math.random() * 27);
                    const gad7Score = Math.floor(Math.random() * 21);
                    
                    this.assessmentHistory.unshift({
                        timestamp: date,
                        phq9: { total: phq9Score, result: this.getDepressionLevel(phq9Score) },
                        gad7: { total: gad7Score, result: this.getAnxietyLevel(gad7Score) },
                        risk_level: this.calculateRiskLevel(phq9Score, gad7Score),
                        recommendations: this.generateRecommendations(phq9Score, gad7Score)
                    });
                }
            }
            
            getDepressionLevel(score) {
                if (score <= 4) return { level: "minimal", description: "Minimal depression symptoms" };
                if (score <= 9) return { level: "mild", description: "Mild depression symptoms" };
                if (score <= 14) return { level: "moderate", description: "Moderate depression symptoms" };
                if (score <= 19) return { level: "moderately_severe", description: "Moderately severe depression symptoms" };
                return { level: "severe", description: "Severe depression symptoms" };
            }
            
            getAnxietyLevel(score) {
                if (score <= 4) return { level: "minimal", description: "Minimal anxiety symptoms" };
                if (score <= 9) return { level: "mild", description: "Mild anxiety symptoms" };
                if (score <= 14) return { level: "moderate", description: "Moderate anxiety symptoms" };
                return { level: "severe", description: "Severe anxiety symptoms" };
            }
            
            calculateRiskLevel(phq9, gad7) {
                if (phq9 > 19 || gad7 > 14) return "high";
                if (phq9 > 9 || gad7 > 9) return "moderate";
                return "low";
            }
            
            generateRecommendations(phq9, gad7) {
                const recommendations = [];
                if (phq9 > 9) recommendations.push("Consider speaking with a mental health professional");
                if (gad7 > 9) recommendations.push("Try relaxation techniques like deep breathing");
                if (phq9 > 4 || gad7 > 4) recommendations.push("Maintain regular sleep schedule");
                return recommendations;
            }
            
            updateQuickStats() {
                document.getElementById('total-assessments').textContent = this.assessmentHistory.length;
                
                if (this.assessmentHistory.length > 0) {
                    const latest = this.assessmentHistory[this.assessmentHistory.length - 1];
                    const lastDate = latest.timestamp.toLocaleDateString();
                    document.getElementById('last-assessment').textContent = lastDate;
                    document.getElementById('current-risk').textContent = latest.risk_level.charAt(0).toUpperCase() + latest.risk_level.slice(1);
                    
                    // Calculate trend
                    if (this.assessmentHistory.length > 1) {
                        const previous = this.assessmentHistory[this.assessmentHistory.length - 2];
                        const currentTotal = latest.phq9.total + latest.gad7.total;
                        const previousTotal = previous.phq9.total + previous.gad7.total;
                        
                        if (currentTotal < previousTotal) {
                            document.getElementById('trend').textContent = 'Improving';
                            document.getElementById('trend').className = 'text-2xl font-bold text-green-600';
                        } else if (currentTotal > previousTotal) {
                            document.getElementById('trend').textContent = 'Declining';
                            document.getElementById('trend').className = 'text-2xl font-bold text-red-600';
                        } else {
                            document.getElementById('trend').textContent = 'Stable';
                            document.getElementById('trend').className = 'text-2xl font-bold text-yellow-600';
                        }
                    }
                }
            }
            
            renderCharts() {
                const labels = this.assessmentHistory.map(a => a.timestamp.toLocaleDateString());
                const phq9Data = this.assessmentHistory.map(a => a.phq9.total);
                const gad7Data = this.assessmentHistory.map(a => a.gad7.total);
                
                // Depression Chart
                const depressionCtx = document.getElementById('depressionChart').getContext('2d');
                this.depressionChart = new Chart(depressionCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'PHQ-9 Score',
                            data: phq9Data,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 27,
                                ticks: {
                                    stepSize: 5
                                }
                            }
                        }
                    }
                });
                
                // Anxiety Chart
                const anxietyCtx = document.getElementById('anxietyChart').getContext('2d');
                this.anxietyChart = new Chart(anxietyCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'GAD-7 Score',
                            data: gad7Data,
                            borderColor: 'rgb(147, 51, 234)',
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 21,
                                ticks: {
                                    stepSize: 3
                                }
                            }
                        }
                    }
                });
            }
            
            renderRecentAssessments() {
                const container = document.getElementById('recent-assessments');
                const recent = this.assessmentHistory.slice(-5).reverse();
                
                container.innerHTML = recent.map(assessment => {
                    const riskColor = assessment.risk_level === 'high' ? 'red' : 
                                     assessment.risk_level === 'moderate' ? 'yellow' : 'green';
                    
                    return `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <span class="text-sm font-medium text-gray-600">${assessment.timestamp.toLocaleDateString()}</span>
                                        <span class="ml-3 px-2 py-1 bg-${riskColor}-100 text-${riskColor}-800 text-xs rounded-full">
                                            ${assessment.risk_level.charAt(0).toUpperCase() + assessment.risk_level.slice(1)} Risk
                                        </span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">Depression (PHQ-9):</span>
                                            <span class="font-semibold ml-2">${assessment.phq9.total}/27</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Anxiety (GAD-7):</span>
                                            <span class="font-semibold ml-2">${assessment.gad7.total}/21</span>
                                        </div>
                                    </div>
                                </div>
                                <button class="text-purple-600 hover:text-purple-800">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderCurrentRecommendations() {
                const container = document.getElementById('current-recommendations');
                
                if (this.assessmentHistory.length > 0) {
                    const latest = this.assessmentHistory[this.assessmentHistory.length - 1];
                    const recommendations = latest.recommendations;
                    
                    if (recommendations.length > 0) {
                        container.innerHTML = recommendations.map(rec => `
                            <div class="flex items-start p-4 bg-green-50 rounded-lg">
                                <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                                <p class="text-green-800">${rec}</p>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-smile text-4xl mb-4"></i>
                                <p>No specific recommendations at this time. Keep up the great work!</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                            <p>Take your first assessment to get personalized recommendations.</p>
                            <a href="/assessment" class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition mt-4 inline-block">
                                Start Assessment
                            </a>
                        </div>
                    `;
                }
            }
            
            async showCrisisModal() {
                document.getElementById('crisis-modal').classList.remove('hidden');
                
                try {
                    const response = await fetch('/api/crisis-resources');
                    const resources = await response.json();
                    
                    // Populate immediate help
                    const immediateHelp = document.getElementById('immediate-help');
                    immediateHelp.innerHTML = resources.immediate_help.map(resource => `
                        <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-400">
                            <h4 class="font-semibold">${resource.name}</h4>
                            <p class="text-sm text-gray-600">${resource.description}</p>
                            ${resource.phone ? `<p class="font-bold text-red-600">Call: ${resource.phone}</p>` : ''}
                            ${resource.text ? `<p class="font-bold text-red-600">Text: ${resource.text}</p>` : ''}
                        </div>
                    `).join('');
                    
                    // Populate mental health resources
                    const mentalHealthResources = document.getElementById('mental-health-resources');
                    mentalHealthResources.innerHTML = resources.mental_health_resources.map(resource => `
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                            <h4 class="font-semibold">${resource.name}</h4>
                            <p class="text-sm text-gray-600">${resource.description}</p>
                            ${resource.phone ? `<p class="font-bold text-blue-600">Call: ${resource.phone}</p>` : ''}
                            ${resource.website ? `<p class="font-bold text-blue-600">Visit: <a href="${resource.website}" target="_blank" class="underline">${resource.website}</a></p>` : ''}
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Failed to load crisis resources:', error);
                }
            }
            
            hideCrisisModal() {
                document.getElementById('crisis-modal').classList.add('hidden');
            }
            
            showError(message) {
                // Simple error display - could be enhanced with a proper notification system
                alert(message);
            }
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new Dashboard();
        });
    </script>
</body>
</html>